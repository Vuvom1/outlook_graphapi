{% extends "base.html" %}

{% block title %}Client Portal - Outlook Email Service{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header text-center bg-primary text-white">
                <h3><i class="fas fa-key me-2"></i>Get Your Outlook Credentials</h3>
                <p class="mb-0">Authenticate with Microsoft to access your Outlook emails</p>
            </div>
            <div class="card-body p-5">
                <!-- Alert for messages -->
                <div id="alert-container" class="mb-3"></div>
                
                {% if not authenticated %}
                <!-- Configuration Check Alert -->
                <div id="config-alert" class="alert alert-warning d-none">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Configuration Required:</strong> Azure credentials are not properly configured. 
                    Please set your <code>AZURE_CLIENT_ID</code> and <code>AZURE_CLIENT_SECRET</code> environment variables.
                </div>
                
                <div class="text-center mb-4">
                    <i class="fas fa-user-lock fa-5x text-muted mb-4"></i>
                    <h4>Authentication Required</h4>
                    <p class="text-muted">Click the button below to authenticate with your Microsoft account and get access to the Outlook Email API.</p>
                </div>

                <div class="d-grid gap-2">
                    <button id="auth-button" class="btn btn-microsoft btn-lg" onclick="authenticateWithMicrosoft()">
                        <i class="fab fa-microsoft me-2"></i>
                        <span id="auth-button-text">Authenticate with Microsoft</span>
                        <span id="auth-spinner" class="spinner-border spinner-border-sm ms-2 d-none" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </span>
                    </button>
                </div>

                <div class="mt-4">
                    <h5><i class="fas fa-info-circle me-2"></i>What happens next?</h5>
                    <ul class="list-unstyled mt-3">
                        <li class="mb-2"><i class="fas fa-check text-success me-2"></i> You'll be redirected to Microsoft's secure login page</li>
                        <li class="mb-2"><i class="fas fa-check text-success me-2"></i> Sign in with your Microsoft/Outlook account</li>
                        <li class="mb-2"><i class="fas fa-check text-success me-2"></i> Grant permissions for email access</li>
                        <li class="mb-2"><i class="fas fa-check text-success me-2"></i> Get your access tokens to use the API</li>
                    </ul>
                </div>

                <div class="alert alert-info mt-4">
                    <i class="fas fa-shield-alt me-2"></i>
                    <strong>Security Note:</strong> Your credentials are processed securely and are not stored permanently on our servers.
                </div>

                {% else %}
                <div class="text-center mb-4">
                    <i class="fas fa-check-circle fa-5x text-success mb-4"></i>
                    <h4 class="text-success">Authentication Successful!</h4>
                    <p class="text-muted">You have successfully authenticated with Microsoft. Your credentials are ready to use.</p>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="card bg-light">
                            <div class="card-header">
                                <h6><i class="fas fa-user me-2"></i>Account Information</h6>
                            </div>
                            <div class="card-body">
                                <p><strong>Email:</strong> {{ user_info.get('email', 'N/A') }}</p>
                                <p><strong>Name:</strong> {{ user_info.get('name', 'N/A') }}</p>
                                <p class="mb-0"><strong>Status:</strong> <span class="badge bg-success">Active</span></p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card bg-light">
                            <div class="card-header">
                                <h6><i class="fas fa-key me-2"></i>Token Information</h6>
                            </div>
                            <div class="card-body">
                                <p><strong>Token Type:</strong> Bearer</p>
                                <p><strong>Expires:</strong> {{ token_expires }}</p>
                                <p class="mb-0"><strong>Scopes:</strong> <span class="badge bg-info">Mail Access</span></p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mt-4">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="mb-0"><i class="fas fa-code me-2"></i>Your Access Token</h6>
                            <button class="btn btn-sm btn-outline-secondary" onclick="copyToken()">
                                <i class="fas fa-copy me-1"></i>Copy
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <textarea id="access-token" class="form-control" rows="4" readonly>{{ access_token or '' }}</textarea>
                            </div>
                            <small class="text-muted">
                                {% if access_token and access_token|length > 50 %}
                                Use this token in the Authorization header: <code>Bearer {{ access_token[:50] }}...</code>
                                {% else %}
                                Use this token in the Authorization header: <code>Bearer [YOUR_TOKEN]</code>
                                {% endif %}
                            </small>
                        </div>
                    </div>
                </div>

                <div class="mt-4 d-grid gap-2">
                    <a href="/client/test-api" class="btn btn-success">
                        <i class="fas fa-play me-2"></i>Test API Connection
                    </a>
                    <a href="/client/logout" class="btn btn-outline-danger">
                        <i class="fas fa-sign-out-alt me-2"></i>Logout
                    </a>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- API Usage Examples -->
        <div class="card mt-4">
            <div class="card-header">
                <h5><i class="fas fa-terminal me-2"></i>API Usage Examples</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>List Emails</h6>
                        <pre><code>curl -H "Authorization: Bearer YOUR_TOKEN" \
  "{{ base_url }}/emails/list?limit=10"</code></pre>
                    </div>
                    <div class="col-md-6">
                        <h6>Send Email</h6>
                        <pre><code>curl -X POST \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"to":["recipient@example.com"],"subject":"Test","body":"Hello!"}' \
  "{{ base_url }}/emails/send"</code></pre>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function copyToken() {
    const tokenField = document.getElementById('access-token');
    tokenField.select();
    document.execCommand('copy');
    
    // Show feedback
    const button = event.target;
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fas fa-check me-1"></i>Copied!';
    button.classList.remove('btn-outline-secondary');
    button.classList.add('btn-success');
    
    setTimeout(() => {
        button.innerHTML = originalText;
        button.classList.remove('btn-success');
        button.classList.add('btn-outline-secondary');
    }, 2000);
}

async function authenticateWithMicrosoft() {
    const button = document.getElementById('auth-button');
    const buttonText = document.getElementById('auth-button-text');
    const spinner = document.getElementById('auth-spinner');
    const alertContainer = document.getElementById('alert-container');
    
    // Show loading state
    button.disabled = true;
    buttonText.textContent = 'Getting authorization URL...';
    spinner.classList.remove('d-none');
    
    // Clear previous alerts
    alertContainer.innerHTML = '';
    
    try {
        // Fetch the OAuth URL from our backend
        const response = await fetch('/oauth/get_authorization_url');
        const data = await response.json();

        if (data.authorization_url) {
            buttonText.textContent = 'Redirecting to Microsoft...';

            // Show success message
            showAlert('success', 'Authorization URL obtained! Redirecting to Microsoft...');
            
            // Small delay for user to see the message
            setTimeout(() => {
                window.location.href = data.authorization_url;
            }, 500);
        } else {
            // Show warning and use fallback
            const errorMsg = data.error || 'Unknown error occurred';
            showAlert('warning', `Using fallback method. ${errorMsg}`);
            
            // Show configuration alert if it's a credentials issue
            if (errorMsg.includes('credentials') || errorMsg.includes('client_id')) {
                document.getElementById('config-alert').classList.remove('d-none');
            }
            
            setTimeout(() => {
                window.location.href = data.fallback_url || '/oauth/get_authorization_url';
            }, 3000);
        }
    } catch (error) {
        console.error('Error fetching auth URL:', error);
        
        // Reset button state
        button.disabled = false;
        buttonText.textContent = 'Authenticate with Microsoft';
        spinner.classList.add('d-none');
        
        // Show error alert
        showAlert('danger', 'Error getting authorization URL. Please try again or contact support.');
    }
}

function showAlert(type, message) {
    const alertContainer = document.getElementById('alert-container');
    const alertHtml = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
            <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'warning' ? 'exclamation-triangle' : 'exclamation-circle'} me-2"></i>
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    alertContainer.innerHTML = alertHtml;
}

</script>
{% endblock %}
